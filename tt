---
- name: Install RabbitMQ on RHEL 9
  hosts: rabbit_nodes
  become: true
  vars:
    # map common arch names to what DNF expects
    basearch_map:
      x86_64: x86_64
      aarch64: aarch64
    my_basearch: "{{ basearch_map[ansible_architecture] | default('x86_64') }}"

  tasks:
    - name: Enable CRB (CodeReady Builder) on RHEL 9
      command: >
        subscription-manager repos --enable
        codeready-builder-for-rhel-9-{{ my_basearch }}-rpms
      register: crb_cmd
      changed_when: "'enabled' in crb_cmd.stdout or 'The repository has been enabled' in crb_cmd.stdout"
      failed_when: false  # harmless if already enabled or if not a subscribed host

    - name: Install EPEL release
      ansible.builtin.dnf:
        name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
        state: present

    - name: Ensure helper packages present
      ansible.builtin.dnf:
        name:
          - curl
          - gnupg2
          - socat
          - logrotate
        state: present

    - name: Add RabbitMQ Erlang repo (Cloudsmith)
      ansible.builtin.yum_repository:
        name: rabbitmq-erlang
        description: "RabbitMQ Erlang for EL9"
        baseurl: "https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/rpm/el/9/$basearch"
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey:
          - https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/gpg.2024.key
          - https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey
        enabled: yes
        metadata_expire: 300

    - name: Add RabbitMQ Server repo (Packagecloud)
      ansible.builtin.yum_repository:
        name: rabbitmq-server
        description: "RabbitMQ Server for EL9"
        baseurl: "https://packagecloud.io/rabbitmq/rabbitmq-server/el/9/$basearch"
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey: https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey
        enabled: yes
        metadata_expire: 300

    - name: Make DNF cache aware of new repos
      ansible.builtin.command: dnf makecache
      changed_when: false

    - name: Install Erlang (from rabbitmq-erlang repo)
      ansible.builtin.dnf:
        name: erlang
        state: present

    - name: Install RabbitMQ server
      ansible.builtin.dnf:
        name: rabbitmq-server
        state: present

    - name: Enable and start RabbitMQ
      ansible.builtin.systemd:
        name: rabbitmq-server
        enabled: true
        state: started

